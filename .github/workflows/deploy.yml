name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 手動実行も可能

jobs:
  build-and-deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell -ExecutionPolicy Bypass -Command "& '{0}'"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          $keyFile = "$sshDir\deploy_key"
          
          if (-not (Test-Path $sshDir)) {
            New-Item -ItemType Directory -Path $sshDir -Force
          }
          
          # 既存のキーファイルがあれば削除（パーミッションをリセットしてから）
          if (Test-Path $keyFile) {
            icacls $keyFile /reset
            Remove-Item $keyFile -Force
          }
          
          # 環境変数から秘密鍵を取得してファイルに書き込み
          $key = $env:SSH_PRIVATE_KEY -replace "`r`n", "`n" -replace "`r", "`n"
          [System.IO.File]::WriteAllText($keyFile, $key + "`n")
          
          # SSH秘密鍵のパーミッション設定
          icacls $keyFile /inheritance:r /grant:r "${env:USERNAME}:R"

      - name: Stop server on remote
        timeout-minutes: 2
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          $deployPath = "${{ secrets.DEPLOY_PATH }}"
          
          # シンプルなコマンドでサーバー停止（.restartファイルを削除してwatcherに任せる方法もあり）
          ssh -i $sshKey -o StrictHostKeyChecking=no -o BatchMode=yes -o ConnectTimeout=30 $target "taskkill /F /IM node.exe 2>nul || echo No node process found"

      - name: Create and upload archive
        timeout-minutes: 5
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          $deployPath = "${{ secrets.DEPLOY_PATH }}"
          
          # ファイルをtarにまとめる
          $items = @('.next', 'app', 'components', 'lib', 'public', 'package.json', 'package-lock.json', 'next.config.ts', 'tsconfig.json', 'postcss.config.mjs')
          $existingItems = ($items | Where-Object { Test-Path $_ }) -join ' '
          
          Write-Host "Creating deployment archive..."
          cmd /c "tar -cf deploy.tar $existingItems"
          
          Write-Host "Uploading archive..."
          scp -i $sshKey -o StrictHostKeyChecking=no -o BatchMode=yes deploy.tar "${target}:deploy.tar"
          
          Remove-Item deploy.tar -Force

      - name: Extract archive on server
        timeout-minutes: 2
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          $deployPath = "${{ secrets.DEPLOY_PATH }}"
          
          # move + extract + cleanup をリモートで実行
          ssh -i $sshKey -o StrictHostKeyChecking=no -o BatchMode=yes $target "move deploy.tar `"$deployPath\deploy.tar`" && cd /d `"$deployPath`" && tar -xf deploy.tar && del deploy.tar"

      - name: Install dependencies on server
        timeout-minutes: 5
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          $deployPath = "${{ secrets.DEPLOY_PATH }}"
          
          ssh -i $sshKey -o StrictHostKeyChecking=no -o BatchMode=yes $target "cd /d `"$deployPath`" && npm ci --omit=dev"

      - name: Restart server
        timeout-minutes: 1
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          $deployPath = "${{ secrets.DEPLOY_PATH }}"
          
          ssh -i $sshKey -o StrictHostKeyChecking=no -o BatchMode=yes $target "echo Deploy from GitHub Actions > `"$deployPath\.restart`""

      - name: Cleanup SSH key
        if: always()
        run: |
          Remove-Item "$env:USERPROFILE\.ssh\deploy_key" -Force -ErrorAction SilentlyContinue

      - name: Deployment completed
        run: echo "Deployment completed successfully!"
