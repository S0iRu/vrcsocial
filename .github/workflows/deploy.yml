name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 手動実行も可能

jobs:
  deploy:
    runs-on: self-hosted  # ローカルネットワーク内のランナーを使用
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build

      - name: Deploy to server
        shell: powershell
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          $NetworkPath = $env:DEPLOY_PATH
          
          Write-Host "Copying files to server..."
          robocopy . $NetworkPath /MIR /XD node_modules .git /XF .gitignore .env.local deploy.ps1 /NJH /NJS /NDL /NC /NS
          
          # Map network drive for npm compatibility
          Write-Host "Mapping network drive..."
          net use Z: $NetworkPath /persistent:no 2>$null
          if (-not $?) { net use Z: /delete /y 2>$null; net use Z: $NetworkPath /persistent:no }
          
          Write-Host "Installing production dependencies..."
          Set-Location Z:\
          npm install --omit=dev
          
          # Cleanup
          Set-Location $env:GITHUB_WORKSPACE
          net use Z: /delete /y 2>$null

      - name: Trigger server restart
        shell: powershell
        env:
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Create restart trigger file on server
          $TriggerFile = "$env:DEPLOY_PATH\.restart"
          $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          Set-Content -Path $TriggerFile -Value $Timestamp
          Write-Host "Restart trigger created at $Timestamp"
          Write-Host "Server will restart when watcher detects the change"
