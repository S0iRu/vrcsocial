name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 手動実行も可能

jobs:
  deploy:
    runs-on: self-hosted  # サーバー上で実行    
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate SERVER_PATH
        shell: powershell
        env:
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          if (-not $env:SERVER_PATH -or $env:SERVER_PATH -eq "") {
            Write-Host "✗ Error: SERVER_PATH secret is not set"
            Write-Host "Please set SERVER_PATH in GitHub Secrets (Settings > Secrets and variables > Actions)"
            exit 1
          }
          Write-Host "✓ SERVER_PATH is set: $env:SERVER_PATH"

      - name: Navigate to server directory
        shell: powershell
        env:
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          $ServerPath = $env:SERVER_PATH
          Write-Host "Server path: $ServerPath"
          
          if (-not (Test-Path $ServerPath)) {
            Write-Host "Creating server directory: $ServerPath"
            New-Item -ItemType Directory -Path $ServerPath -Force | Out-Null
          }
          
          Set-Location $ServerPath
          Write-Host "Current directory: $(Get-Location)"

      - name: Pull latest code
        shell: powershell
        env:
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          Set-Location $env:SERVER_PATH
          
          if (Test-Path ".git") {
            Write-Host "Pulling latest changes from main branch..."
            git fetch origin
            git reset --hard origin/main
            git clean -fd
          } else {
            Write-Host "Initializing git repository..."
            git init
            $RepoUrl = "${{ github.server_url }}/${{ github.repository }}"
            git remote add origin $RepoUrl 2>$null
            if ($LASTEXITCODE -ne 0) {
              git remote set-url origin $RepoUrl
            }
            git fetch origin
            git checkout -b main
            git reset --hard origin/main
          }
          
          Write-Host "Current commit: $(git rev-parse HEAD)"
          Write-Host "Current branch: $(git branch --show-current)"

      - name: Install dependencies
        shell: powershell
        env:
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          Set-Location $env:SERVER_PATH
          Write-Host "Installing dependencies..."
          npm ci

      - name: Build application
        shell: powershell
        env:
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
          NODE_ENV: production
        run: |
          Set-Location $env:SERVER_PATH
          Write-Host "Building application..."
          npm run build
          Write-Host "Build completed successfully!"

      - name: Trigger server restart
        shell: powershell
        env:
          SERVER_PATH: ${{ secrets.SERVER_PATH }}
        run: |
          $TriggerFile = "$env:SERVER_PATH\.restart"
          $Timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
          
          Write-Host "Creating restart trigger file..."
          Set-Content -Path $TriggerFile -Value $Timestamp
          Write-Host "Restart trigger created at $Timestamp"
          Write-Host "Server will restart when watcher detects the change"
          
          # Verify the file was created
          if (Test-Path $TriggerFile) {
            Write-Host "✓ Restart trigger file created successfully"
          } else {
            Write-Host "✗ Failed to create restart trigger file"
            exit 1
          }
