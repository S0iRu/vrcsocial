name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # 手動実行も可能

jobs:
  build-and-deploy:
    runs-on: self-hosted
    defaults:
      run:
        shell: powershell -ExecutionPolicy Bypass -Command "& '{0}'"
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Setup SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.SERVER_SSH_KEY }}
        run: |
          $sshDir = "$env:USERPROFILE\.ssh"
          if (-not (Test-Path $sshDir)) {
            New-Item -ItemType Directory -Path $sshDir -Force
          }
          
          # 環境変数から秘密鍵を取得してファイルに書き込み
          $key = $env:SSH_PRIVATE_KEY -replace "`r`n", "`n" -replace "`r", "`n"
          [System.IO.File]::WriteAllText("$sshDir\deploy_key", $key + "`n")
          
          # SSH秘密鍵のパーミッション設定
          icacls "$sshDir\deploy_key" /inheritance:r /grant:r "${env:USERNAME}:R"

      - name: Stop server on remote
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          
          ssh -i $sshKey -o StrictHostKeyChecking=no $target "powershell -Command `"& { `$p = netstat -ano | Select-String ':3000\s+.*LISTENING' | ForEach-Object { (`$_ -split '\s+')[-1] } | Select-Object -First 1; if (`$p) { Stop-Process -Id `$p -Force -ErrorAction SilentlyContinue; Start-Sleep 3 } }`""

      - name: Deploy files to server
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $sshOpts = "-o StrictHostKeyChecking=no"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          $deployPath = "${{ secrets.DEPLOY_PATH }}"
          
          # 必要なファイル/フォルダを転送
          $items = @('.next', 'app', 'components', 'lib', 'public', 'package.json', 'package-lock.json', 'next.config.ts', 'tsconfig.json', 'postcss.config.mjs')
          
          foreach ($item in $items) {
            if (Test-Path $item) {
              Write-Host "Deploying $item..."
              scp -i $sshKey $sshOpts -r $item "${target}:${deployPath}/"
            }
          }

      - name: Install dependencies on server
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          $deployPath = "${{ secrets.DEPLOY_PATH }}"
          
          ssh -i $sshKey -o StrictHostKeyChecking=no $target "cd $deployPath && npm ci --omit=dev"

      - name: Restart server
        run: |
          $sshKey = "$env:USERPROFILE\.ssh\deploy_key"
          $target = "${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }}"
          $deployPath = "${{ secrets.DEPLOY_PATH }}"
          
          ssh -i $sshKey -o StrictHostKeyChecking=no $target "powershell -Command `"Set-Content -Path '$deployPath\.restart' -Value 'Deploy from GitHub Actions'`""

      - name: Cleanup SSH key
        if: always()
        run: |
          Remove-Item "$env:USERPROFILE\.ssh\deploy_key" -Force -ErrorAction SilentlyContinue

      - name: Deployment completed
        run: echo "Deployment completed successfully!"
